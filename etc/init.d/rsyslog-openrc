#!/sbin/openrc-run

description="Rsyslog is an enhanced multi-threaded syslogd"

command="/usr/sbin/rsyslogd"
pidfile="/run/rsyslogd.pid"

depend() {
    need mountall
    after bootmisc
}

sendsigs_omit() {
    local omitdir="/run/sendsigs.omit.d"
    mkdir -p "$omitdir"
    ln -sf "${pidfile}" "$omitdir/rsyslog"
}

start() {
    ebegin "Starting Rsyslog"
    sendsigs_omit
    start-stop-daemon --start --exec "${command}" --pidfile "${pidfile}" --background
    eend $?
}

stop() {
    ebegin "Stopping Rsyslog"
    if [ -f "${pidfile}" ]; then
        local pid
        pid=$(cat "${pidfile}")
        if kill "${pid}" 2>/dev/null; then
            sleep 1
            if kill -0 "${pid}" 2>/dev/null; then
                kill -9 "${pid}" 2>/dev/null
            fi
            rm -f "${pidfile}"
            eend 0
        else
            eend 1
        fi
    else
        eerror "PID file not found"
        eend 1
    fi
}
