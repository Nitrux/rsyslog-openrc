#!/sbin/openrc-run

description="Rsyslog is an enhanced multi-threaded syslogd"
description_start="Starting enhanced syslogd"
description_stop="Stopping enhanced syslogd"

DAEMON=/usr/sbin/rsyslogd
PIDFILE=/run/rsyslogd.pid
RSYSLOGD_OPTIONS=""

depend() {
    need mountall
    after bootmisc
    use logger
}

start_pre() {
    # Exit if the daemon is not installed
    if [ ! -x "${DAEMON}" ]; then
        eerror "Daemon ${DAEMON} not installed or not executable"
        return 1
    fi

    # Read configuration variable file if it is present
    if [ -r /etc/default/rsyslog ]; then
        . "/etc/default/rsyslog"
    else
        ewarn "Configuration file /etc/default/rsyslog not found"
    fi
}

start() {
    ebegin "${description_start}"
    create_xconsole
    start-stop-daemon --start --quiet --pidfile ${PIDFILE} --exec ${DAEMON} -- ${RSYSLOGD_OPTIONS}
    sendsigs_omit
    eend $?
}

stop() {
    ebegin "${description_stop}"
    start-stop-daemon --stop --quiet --retry=TERM/30/KILL/5 --pidfile ${PIDFILE} --exec ${DAEMON}
    eend $?
}

rotate() {
    ebegin "Closing open files"
    start-stop-daemon --stop --signal HUP --quiet --pidfile ${PIDFILE} --exec ${DAEMON}
    eend $?
}

status() {
    status
}

restart() {
    ebegin "Restarting enhanced syslogd"
    stop
    start
    eend $?
}

create_xconsole() {
    XCONSOLE=/dev/xconsole
    if [ "$(uname -s)" != "Linux" ]; then
        XCONSOLE=/run/xconsole
        ln -sf $XCONSOLE /dev/xconsole
    fi
    if [ ! -e $XCONSOLE ]; then
        mknod -m 640 $XCONSOLE p
        chown root:adm $XCONSOLE
        [ -x /sbin/restorecon ] && /sbin/restorecon $XCONSOLE
    fi
}

sendsigs_omit() {
    OMITDIR=/run/sendsigs.omit.d
    mkdir -p $OMITDIR
    ln -sf $PIDFILE $OMITDIR/rsyslog
}
